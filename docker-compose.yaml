# Andre - Docker Compose with Security Hardening
# See: https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html

networks:
  # External network - allows internet access (needed for Spotify/OAuth APIs)
  andre_network:
    driver: bridge
    internal: false

  # Internal network - no internet access (for Redis isolation)
  andre_internal:
    driver: bridge
    internal: true

services:
  redis:
    image: redis:7-alpine@sha256:02f2cc4882f8bf87c79a220ac958f58c700bdec0dfb9b9ea61b62fb0e8f1bfcf
    container_name: andre_redis
    # Security: password auth, protected mode
    # Note: ACL-based command restrictions require redis.conf file mount (see SECURITY.md)
    # Current config uses requirepass for authentication
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD:-changeme} --protected-mode yes
    # Redis only on internal network - no internet access
    networks:
      - andre_internal
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    # Security: read-only filesystem
    read_only: true
    tmpfs:
      - /tmp
    # Security: drop all capabilities, add back only what Redis needs
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID  # Required for Redis to switch to redis user
      - SETUID  # Required for Redis to switch to redis user
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  andre:
    build: .
    container_name: andre_app
    # Security: run as non-root user
    user: "1000:1000"
    depends_on:
      redis:
        condition: service_healthy
    # Both networks: internal for Redis, external for Spotify API
    networks:
      - andre_network
      - andre_internal
    ports:
      - "5001:5000"
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
    volumes:
      - ./local_config.yaml:/app/local_config.yaml:ro
      - ./play_logs:/app/play_logs
      - ./oauth_creds:/app/oauth_creds
    # Security: read-only filesystem with exceptions
    read_only: true
    tmpfs:
      - /tmp
      - /app/__pycache__
    # Security: drop all capabilities, prevent privilege escalation
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M
    # Health check using /health endpoint
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  player:
    build: .
    container_name: andre_player
    # Security: run as non-root user
    user: "1000:1000"
    depends_on:
      - andre
    # Both networks: internal for Redis, external for Spotify API
    networks:
      - andre_network
      - andre_internal
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
    volumes:
      - ./local_config.yaml:/app/local_config.yaml:ro
      - ./play_logs:/app/play_logs
      - ./oauth_creds:/app/oauth_creds
    # Security: read-only filesystem with exceptions
    read_only: true
    tmpfs:
      - /tmp
      - /app/__pycache__
    # Security: drop all capabilities, prevent privilege escalation
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    command: ["python", "master_player.py"]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # PostgreSQL is optional - uncomment if you need it for user data
  # db:
  #   image: postgres:15-alpine
  #   container_name: andre_postgres
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     POSTGRES_DB: andre_database
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 5s
  #     timeout: 3s
  #     retries: 3
  #   restart: unless-stopped

volumes:
  redis_data:
  # postgres_data:
